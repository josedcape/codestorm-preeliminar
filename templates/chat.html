{% extends "base.html" %}

{% block title %}CODESTORM - Chat con Agente Especializado{% endblock %}

{% block extra_css %}
<!-- Google Fonts - Carga optimizada -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<!-- Highlight.js para resaltado de sintaxis -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

<!-- Socket.IO para comunicación en tiempo real -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

<style>
/* Estilos generales */
.chat-interface {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    max-width: 100%;
}

.chat-header {
    padding: 15px;
    background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
}

.chat-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: rgba(9, 20, 40, 0.7);
}

.chat-input-area {
    display: flex;
    padding: 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.input-addons {
    display: flex;
    gap: 10px;
    margin-right: 10px;
}

.chat-input-wrapper {
    flex: 1;
    position: relative;
}

.chat-input {
    width: 100%;
    border: 1px solid rgba(255, 215, 0, 0.2);
    background-color: rgba(9, 20, 40, 0.8);
    color: #fff;
    padding: 12px 15px;
    border-radius: 8px;
    resize: none;
    font-family: 'Inter', sans-serif;
    height: 50px;
    max-height: 150px;
    overflow-y: auto;
    transition: all 0.3s ease;
}

.chat-input:focus {
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    outline: none;
}

.chat-buttons {
    display: flex;
    gap: 10px;
    margin-left: 10px;
}

.action-button {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    color: #FFC107;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    background: linear-gradient(135deg, #0A2149 0%, #0c1e3a 100%);
}

.action-button:active {
    transform: translateY(1px);
}

.action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.action-button i {
    font-size: 1.2rem;
}

.send-button {
    background: linear-gradient(135deg, #0c1e3a 0%, #0A2149 100%);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.send-button:hover {
    background: linear-gradient(135deg, #0c2657 0%, #0c2657 100%);
    border-color: rgba(255, 215, 0, 0.5);
}

.file-upload-button, .voice-button {
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Mensajes del chat */
.chat-message {
    margin-bottom: 20px;
    max-width: 90%;
    animation: fadeIn 0.3s ease-out;
}

.user-message {
    margin-left: auto;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    border-radius: 12px 12px 2px 12px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.agent-message {
    margin-right: auto;
    background: linear-gradient(135deg, #091428 0%, #0A2149 100%);
    border-radius: 12px 12px 12px 2px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(100, 149, 237, 0.2);
}

.system-message {
    margin: 10px auto;
    background-color: rgba(10, 33, 73, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    max-width: 90%;
    border: 1px solid rgba(255, 215, 0, 0.1);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.message-sender {
    font-weight: 600;
    color: #FFC107;
}

.message-time {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.message-content {
    color: #fff;
    line-height: 1.5;
}

.message-content p {
    margin-bottom: 1rem;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.message-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.message-agent, .message-user {
    display: flex;
    align-items: center;
    gap: 5px;
}

.copy-message {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.6);
    border-radius: 4px;
    padding: 2px 5px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-message:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

/* Selector de Agentes y Modelos */
.selector-section {
    background: linear-gradient(180deg, rgba(9, 20, 40, 0.8) 0%, rgba(10, 33, 73, 0.8) 100%);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    border: 1px solid rgba(255, 215, 0, 0.15);
}

.selector-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    margin-right: 10px;
    white-space: nowrap;
}

.selector-dropdown {
    flex: 1;
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 5px;
    color: #fff;
    padding: 5px 10px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.selector-dropdown:focus {
    border-color: rgba(255, 215, 0, 0.5);
    outline: none;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
}

.agent-info-panel {
    display: flex;
    background: linear-gradient(135deg, rgba(9, 20, 40, 0.6) 0%, rgba(10, 33, 73, 0.6) 100%);
    border-radius: 8px;
    padding: 12px;
    margin: 0 15px 15px;
    border: 1px solid rgba(255, 215, 0, 0.15);
    align-items: center;
}

.agent-icon {
    width: 50px;
    height: 50px;
    border-radius: 25px;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFC107;
    font-size: 1.5rem;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
    margin-right: 15px;
    flex-shrink: 0;
}

.agent-details {
    flex: 1;
}

.agent-name {
    font-weight: 600;
    color: #FFC107;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.agent-description {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin-bottom: 0;
}

.agent-capabilities {
    margin-top: 8px;
    padding-left: 20px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
}

.agent-capabilities li {
    margin-bottom: 3px;
}

/* Código */
pre {
    background-color: #282c34;
    border-radius: 8px;
    padding: 15px;
    overflow-x: auto;
    margin: 10px 0;
    position: relative;
}

pre code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #21252b;
    padding: 8px 15px;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #181a1f;
    font-family: 'Inter', sans-serif;
    margin-top: 10px;
}

.code-language {
    font-size: 0.8rem;
    color: #abb2bf;
    font-weight: 600;
}

.code-buttons {
    display: flex;
    gap: 10px;
}

.code-button {
    background-color: transparent;
    border: none;
    color: #abb2bf;
    cursor: pointer;
    padding: 2px 5px;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.code-button:hover {
    color: #fff;
}

/* Botón de carga de archivos */
.file-input {
    display: none;
}

/* Indicador de carga */
.loading-animation {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    gap: 8px;
}

.loading-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 215, 0, 0.6);
    animation: loadingAnimation 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes loadingAnimation {
    0%, 80%, 100% {
    transform: scale(0);
    }
    40% {
    transform: scale(1);
    }
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Estilos para código inline */
.inline-code {
    font-family: 'JetBrains Mono', monospace;
    background-color: rgba(40, 44, 52, 0.5);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #e6e6e6;
}

/* Estilos para los enlaces */
.chat-link {
    color: #3498db;
    text-decoration: none;
    border-bottom: 1px dotted #3498db;
    transition: all 0.2s ease;
}

.chat-link:hover {
    color: #2980b9;
    border-bottom: 1px solid #2980b9;
}

/* Indicador de estado de conexión */
.connection-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.connection-status.connected {
    background-color: #4CAF50;
    box-shadow: 0 0 5px #4CAF50;
}

.connection-status.connecting {
    background-color: #FFC107;
    box-shadow: 0 0 5px #FFC107;
    animation: pulse 1s infinite;
}

.connection-status.disconnected {
    background-color: #F44336;
    box-shadow: 0 0 5px #F44336;
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    column-gap: 5px;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    float: left;
    margin: 0 1px;
    background-color: rgba(255, 215, 0, 0.5);
    display: block;
    border-radius: 50%;
    opacity: 0.4;
}

.typing-indicator span:nth-of-type(1) {
    animation: 1s blink infinite 0.3333s;
}

.typing-indicator span:nth-of-type(2) {
    animation: 1s blink infinite 0.6666s;
}

.typing-indicator span:nth-of-type(3) {
    animation: 1s blink infinite 0.9999s;
}

@keyframes blink {
    50% {
        opacity: 1;
    }
}

/* Shimmer effect */
.shimmer-effect {
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* Copy tooltip */
.copy-tooltip {
    position: absolute;
    top: -30px;
    right: 10px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    animation: fadeIn 0.3s ease-out;
}

/* Responsivo */
@media (max-width: 768px) {
    .chat-controls {
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    }

    .selector-section {
    width: 100%;
    }

    .agent-info-panel {
    flex-direction: column;
    text-align: center;
    }

    .agent-icon {
    margin: 0 auto 10px;
    }

    .chat-input-area {
    flex-direction: column;
    gap: 10px;
    }

    .input-addons {
    width: 100%;
    justify-content: space-between;
    }

    .chat-buttons {
    width: 100%;
    justify-content: space-between;
    margin-left: 0;
    }

    .chat-interface {
    height: calc(100vh - 280px);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
    <!-- Interfaz de Chat Rediseñada -->
    <div class="col-12">
    <div class="card card-futuristic">
    <!-- Cabecera con título -->
    <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
    <span><i class="bi bi-cpu me-2"></i>Chat con Agente Especializado</span>
    <div id="connection-status" class="connection-status" title="Estado de conexión"></div>
    </div>

    <!-- Contenido del chat -->
    <div class="card-body p-0">
    <!-- Panel de control superior -->
    <div class="chat-controls">
    <!-- Selector de Modelo -->
    <div class="selector-section">
    <span class="selector-label">Modelo de IA:</span>
    <select id="model-select" class="selector-dropdown">
    <option value="openai" selected>OpenAI (GPT-4o)</option>
    <option value="anthropic">Anthropic (Claude)</option>
    <option value="gemini">Google (Gemini)</option>
    </select>
    </div>

    <!-- Selector de Agente -->
    <div class="selector-section">
    <span class="selector-label">Agente:</span>
    <select id="agent-selector" class="selector-dropdown">
    <option value="developer" selected>Agente de Desarrollo</option>
    <option value="architect">Arquitecto de Software</option>
    <option value="advanced">Especialista Avanzado</option>
    <option value="general">Asistente General</option>
    </select>
    </div>

    <!-- Selector de Documentos -->
    <div class="selector-section">
    <span class="selector-label">Documento:</span>
    <select id="document-selector" class="selector-dropdown">
    <option value="" selected>Sin documento</option>
    <!-- Aquí se cargarán dinámicamente los documentos disponibles -->
    </select>
    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#documentModal">
    <i class="bi bi-file-earmark-plus"></i>
    </button>
    </div>
    </div>

    <!-- Información del agente seleccionado -->
    <div class="agent-info-panel">
    <div class="agent-icon">
    <i class="bi bi-code-slash" id="agent-icon"></i>
    </div>
    <div class="agent-details">
    <h5 class="agent-name" id="agent-name">Agente de Desarrollo</h5>
    <p class="agent-description" id="agent-description">Experto en optimización y edición de código en tiempo real</p>
    <ul class="agent-capabilities" id="agent-capabilities">
        <li>Corrección y refactorización de código</li>
        <li>Optimización de rendimiento</li>
        <li>Integración de frameworks y librerías</li>
    </ul>
    </div>
    </div>

    <!-- Contenedor de mensajes -->
    <div class="chat-interface">
    <div class="chat-messages-container" id="chat-messages">
    <!-- Mensaje de bienvenida del sistema -->
    <div class="chat-message system-message">
    <div class="message-content">
    <p>¡Bienvenido al chat especializado de CODESTORM! Estás hablando con el <strong>Agente de Desarrollo</strong>, un experto en optimización y edición de código en tiempo real.</p>
    </div>
    </div>
    <!-- Aquí se añadirán dinámicamente los mensajes -->
    </div>

    <!-- Área de entrada de texto y botones -->
    <div class="chat-input-area">
    <div class="input-addons">
    <button type="button" class="action-button file-upload-button" id="file-button" title="Subir archivo">
    <i class="bi bi-paperclip"></i>
    </button>
    <input type="file" id="file-input" class="file-input" multiple>

    <button type="button" class="action-button voice-button" id="voice-button" title="Reconocimiento de voz">
    <i class="bi bi-mic"></i>
    </button>
    </div>

    <div class="chat-input-wrapper">
    <textarea id="chat-input" class="chat-input" placeholder="Escribe tu mensaje aquí... Por ejemplo: 'Crea una página de ventas para productos tecnológicos'" rows="1"></textarea>
    </div>

    <div class="chat-buttons">
    <button type="button" class="action-button send-button" id="send-button">
    <i class="bi bi-send"></i>
    </button>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- Previsualización (inicialmente oculta) -->
    <div class="col-12 mt-4" id="preview-section" style="display: none;">
    <div class="card card-futuristic">
    <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
    <span><i class="bi bi-window me-2"></i>Previsualización</span>
    <div>
    <button id="toggle-preview" class="btn btn-sm btn-futuristic">
    <i class="bi bi-x-lg"></i>
    </button>
    </div>
    </div>
    <div class="card-body p-0">
    <div class="device-toggle-buttons py-2">
    <button class="device-toggle-btn active" data-device="desktop">
    <i class="bi bi-laptop"></i> Escritorio
    </button>
    <button class="device-toggle-btn" data-device="tablet">
    <i class="bi bi-tablet"></i> Tablet
    </button>
    <button class="device-toggle-btn" data-device="mobile">
    <i class="bi bi-phone"></i> Móvil
    </button>
    </div>

    <div class="preview-container" id="preview-container">
    <div class="preview-header">
    <div class="preview-controls">
    <div class="control-btn control-close"></div>
    <div class="control-btn control-minimize"></div>
    <div class="control-btn control-expand"></div>
    </div>
    <div class="preview-url">
    <span>preview.html</span>
    </div>
    </div>
    <iframe id="preview-iframe" class="preview-iframe" title="Previsualización"></iframe>
    </div>
    </div>
    </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// CODESTORM - Sistema de chat con agentes especializados y funcionalidades avanzadas

// Variables globales
let socket;

// Función para obtener la hora actual formateada
function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Función para escapar HTML y prevenir XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Función para formatear Markdown a HTML
function formatMarkdown(text) {
  // Implementación básica de Markdown
  // Código en bloque con resaltado de sintaxis
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, language, code) {
    language = language || 'plaintext';
    return `<div class="code-block"><pre><code class="language-${language}">${escapeHtml(code.trim())}</code></pre></div>`;
  });

  // Código en línea
  text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');

  // Enlaces
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="chat-link" target="_blank">$1</a>');

  // Negritas
  text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

  // Cursivas
  text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

  // Listas
  text = text.replace(/^\s*-\s+(.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

  // Párrafos (asegurarse de que el contenido esté en párrafos)
  const paragraphs = text.split('\n\n');
  return paragraphs.map(p => {
    if (p.trim() === '') return '';
    if (p.startsWith('<ul>') || p.startsWith('<div class="code-block">')) return p;
    return `<p>${p.replace(/\n/g, '<br>')}</p>`;
  }).join('');
}

// Función para desplazarse al final del contenedor de mensajes
function scrollToBottom(container) {
  if (!container) return;
  container.scrollTop = container.scrollHeight;
}

// Función para añadir mensaje de sistema
function addSystemMessage(message) {
  const chatMessages = document.getElementById('chat-messages');
  if (!chatMessages) return;

  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message system-message';

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.innerHTML = message;

  messageElement.appendChild(messageContent);
  chatMessages.appendChild(messageElement);

  scrollToBottom(chatMessages);
}

// Función para añadir indicador de carga
function addLoadingMessage() {
  const chatMessages = document.getElementById('chat-messages');
  if (!chatMessages) return;

  // Eliminar cualquier indicador de carga existente
  removeLoadingMessage();

  const loadingElement = document.createElement('div');
  loadingElement.className = 'chat-message agent-message loading-message';
  loadingElement.innerHTML = `
    <div class="loading-animation">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  `;

  chatMessages.appendChild(loadingElement);
  scrollToBottom(chatMessages);
}

// Función para eliminar indicador de carga
function removeLoadingMessage() {
  const loadingMessage = document.querySelector('.loading-message');
  if (loadingMessage) {
    loadingMessage.remove();
  }
}

// Función para copiar el contenido de un mensaje al portapapeles
function copyMessageToClipboard(messageElement) {
  if (!messageElement) return;

  // Obtener el contenido del mensaje
  const messageContent = messageElement.querySelector('.message-content');
  if (!messageContent) return;

  // Extraer el texto plano del contenido HTML para copiar
  const textToCopy = messageContent.textContent.trim();

  // Usar la API del portapapeles moderna si está disponible
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        showCopyFeedback(messageElement);
      })
      .catch(err => {
        console.error('Error al copiar texto: ', err);
        // Fallback al método alternativo
        fallbackCopyToClipboard(textToCopy, messageElement);
      });
  } else {
    // Método alternativo para contextos no seguros o navegadores antiguos
    fallbackCopyToClipboard(textToCopy, messageElement);
  }
}

// Método alternativo para copiar al portapapeles
function fallbackCopyToClipboard(text, messageElement) {
  // Crear un elemento textarea temporal
  const textArea = document.createElement("textarea");
  textArea.value = text;

  // Hacer que el textarea no sea visible
  textArea.style.position = "fixed";
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.width = "2em";
  textArea.style.height = "2em";
  textArea.style.padding = "0";
  textArea.style.border = "none";
  textArea.style.outline = "none";
  textArea.style.boxShadow = "none";
  textArea.style.background = "transparent";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  let successful = false;
  try {
    successful = document.execCommand('copy');
  } catch (err) {
    console.error('Error en fallback de copiar:', err);
  }

  document.body.removeChild(textArea);

  if (successful) {
    showCopyFeedback(messageElement);
  }
}

// Mostrar feedback visual al copiar
function showCopyFeedback(messageElement) {
  // Encontrar el botón de copiar
  const copyButton = messageElement.querySelector('.copy-message');
  if (!copyButton) return;

  // Cambiar el ícono temporalmente
  const originalHTML = copyButton.innerHTML;
  copyButton.innerHTML = '<i class="bi bi-check"></i>';
  copyButton.title = '¡Copiado!';
  copyButton.classList.add('btn-success');
  copyButton.classList.remove('btn-outline-light');

  // Mostrar un tooltip o mensaje emergente
  const tooltip = document.createElement('div');
  tooltip.className = 'copy-tooltip';
  tooltip.textContent = '¡Copiado al portapapeles!';
  messageElement.appendChild(tooltip);

  // Eliminar el tooltip después de un tiempo
  setTimeout(() => {
    if (tooltip && tooltip.parentNode) {
      tooltip.parentNode.removeChild(tooltip);
    }
  }, 2000);

  // Restaurar el botón después de un tiempo
  setTimeout(() => {
    copyButton.innerHTML = originalHTML;
    copyButton.title = 'Copiar mensaje';
    copyButton.classList.remove('btn-success');
    copyButton.classList.add('btn-outline-light');
  }, 1500);
}

// Mejorar el HTML para previsualización añadiendo meta tags y estilos necesarios
function enhanceHtmlForPreview(htmlContent) {
  // Si el HTML no tiene estructura completa, agregar las etiquetas básicas
  if (!htmlContent.includes('<!DOCTYPE html>')) {
    htmlContent = `<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Previsualización CODESTORM</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        margin: 0;
        padding: 20px;
      }
    </style>
</head>
<body>
${htmlContent}
</body>
</html>`;
  }

  // Asegurar que tenga viewport para dispositivos móviles
  if (!htmlContent.includes('<meta name="viewport"') && htmlContent.includes('<head>')) {
    htmlContent = htmlContent.replace(
      '<head>',
      '<head>\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">'
    );
  }

  return htmlContent;
}

// Función para abrir previsualización en una nueva ventana o pestaña
function openPreviewInNewWindow(htmlContent) {
  const enhancedHtml = enhanceHtmlForPreview(htmlContent);
  const newWindow = window.open('', '_blank');
  if (newWindow) {
    newWindow.document.write(enhancedHtml);
    newWindow.document.close();
  } else {
    alert('El navegador bloqueó la apertura de una nueva ventana. Por favor, permita ventanas emergentes para este sitio.');
  }
}

// Función para mostrar previsualización en el iframe
function showPreview(htmlContent) {
  const previewSection = document.getElementById('preview-section');
  const previewIframe = document.getElementById('preview-iframe');

  if (!previewSection || !previewIframe) return;

  // Mostrar la sección de previsualización
  previewSection.style.display = 'block';

  // Actualizar el contenido del iframe
  const iframe = previewIframe;
  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

  iframeDoc.open();
  iframeDoc.write(htmlContent);
  iframeDoc.close();

  // Configurar botón para cerrar previsualización
  const togglePreviewBtn = document.getElementById('toggle-preview');
  if (togglePreviewBtn) {
    togglePreviewBtn.onclick = function() {
      previewSection.style.display = 'none';
    };
  }

  // Configurar botones de dispositivo
  const deviceButtons = document.querySelectorAll('.device-toggle-btn');
  deviceButtons.forEach(button => {
    button.addEventListener('click', function() {
      // Quitar clase activa de todos los botones
      deviceButtons.forEach(btn => btn.classList.remove('active'));
      // Añadir clase activa al botón clickeado
      this.classList.add('active');

      // Cambiar tamaño del iframe según el dispositivo
      const device = this.getAttribute('data-device');
      const previewContainer = document.getElementById('preview-container');

      if (device === 'desktop') {
        previewContainer.className = 'preview-container';
        iframe.style.width = '100%';
        iframe.style.height = '600px';
      } else if (device === 'tablet') {
        previewContainer.className = 'preview-container tablet-view';
        iframe.style.width = '768px';
        iframe.style.height = '1024px';
      } else if (device === 'mobile') {
        previewContainer.className = 'preview-container mobile-view';
        iframe.style.width = '375px';
        iframe.style.height = '667px';
      }
    });
  });
}

// Función para verificar si hay un mensaje en la URL
function checkMessageFromUrl(chatInput) {
  const urlParams = new URLSearchParams(window.location.search);
  const message = urlParams.get('message');

  if (message && chatInput) {
    chatInput.value = decodeURIComponent(message);
    chatInput.dispatchEvent(new Event('input'));
  }
}

// Función para procesar código HTML para previsualización
function processHtmlCodeForPreview(text) {
  // Buscar bloques de código HTML
  const htmlRegex = /```html([\s\S]*?)```/g;
  const htmlMatches = text.match(htmlRegex);

  if (htmlMatches && htmlMatches.length > 0) {
    // Extraer el contenido HTML del primer bloque
    const htmlContent = htmlMatches[0].replace(/```html/, '').replace(/```$/, '').trim();

    // Si existe contenido HTML válido, mostrar previsualización
    if (htmlContent && (htmlContent.includes('<html') || htmlContent.includes('<body') || htmlContent.includes('<div'))) {
      // Mejorar el HTML añadiendo referencias necesarias y estilos
      const enhancedHtml = enhanceHtmlForPreview(htmlContent);

      // Mostrar en el iframe de previsualización
      showPreview(enhancedHtml);

      // Añadir botones para opciones de previsualización en el mensaje
      const lastMessage = document.querySelector('.chat-message.agent-message:last-child .message-content');
      if (lastMessage) {
        const previewButtonsHtml = `
          <div class="preview-actions mt-3">
            <button class="btn btn-sm btn-futuristic" onclick="document.getElementById('preview-section').scrollIntoView({behavior: 'smooth'})">
              <i class="bi bi-eye"></i> Ver previsualización
            </button>
            <a href="/preview" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
              <i class="bi bi-window"></i> Previsualización Simple
            </a>
            <a href="/web_preview" target="_blank" class="btn btn-sm btn-outline-info ms-2">
              <i class="bi bi-code-slash"></i> Editor Web Avanzado
            </a>
          </div>
        `;

        // Agregar los botones si no existen ya
        if (!lastMessage.querySelector('.preview-actions')) {
          lastMessage.insertAdjacentHTML('beforeend', previewButtonsHtml);
        }
      }

      return true; // Se procesó el HTML
    }
  }

  return false; // No se encontró HTML para procesar
}

// Función para copiar código
function copyCode(button) {
  const codeBlock = button.closest('.code-header').nextElementSibling.querySelector('code');
  const codeText = codeBlock.textContent;

  navigator.clipboard.writeText(codeText)
    .then(() => {
      // Cambiar ícono y texto temporalmente para indicar éxito
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="bi bi-clipboard-check"></i> Copiado';

      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    })
    .catch(err => {
      console.error('Error al copiar código:', err);
      alert('No se pudo copiar el código. Intente manualmente.');
    });
}

// Añadir mensaje del usuario al chat con estilo futurista
function addUserMessage(message) {
  const chatMessages = document.getElementById('chat-messages');

  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message user-message';

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.innerHTML = `<p>${escapeHtml(message)}</p>`;

  const messageInfo = document.createElement('div');
  messageInfo.className = 'message-info';
  messageInfo.innerHTML = `<span class="message-time">${getCurrentTime()}</span>
                           <span class="message-user">Tú</span>`;

  messageElement.appendChild(messageContent);
  messageElement.appendChild(messageInfo);

  chatMessages.appendChild(messageElement);
  scrollToBottom(chatMessages);

  return messageElement;
}

// Añadir mensaje del agente al chat con estilo futurista
function addAgentMessage(message, agent) {
  const chatMessages = document.getElementById('chat-messages');

  // Verificar si el agente está definido, y si no, usar un valor predeterminado
  agent = agent || {
    name: 'Asistente',
    icon: 'bi-robot',
    id: 'general'
  };

  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message agent-message';

  // Convertir Markdown a HTML con resaltado de sintaxis mejorado
  const formattedMessage = formatMarkdown(message);

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.innerHTML = formattedMessage;

  const messageInfo = document.createElement('div');
  messageInfo.className = 'message-info';
  messageInfo.innerHTML = `<span class="message-time">${getCurrentTime()}</span>
                           <span class="message-agent"><i class="bi ${agent.icon}"></i> ${agent.name}</span>
                           <button class="btn btn-sm btn-outline-light copy-message" title="Copiar mensaje">
                             <i class="bi bi-clipboard"></i>
                           </button>`;

  messageElement.appendChild(messageContent);
  messageElement.appendChild(messageInfo);

  chatMessages.appendChild(messageElement);

  // Configurar el botón de copiar
  const copyButton = messageElement.querySelector('.copy-message');
  if (copyButton) {
    copyButton.addEventListener('click', function() {
      copyMessageToClipboard(this.closest('.chat-message.agent-message'));
    });
  }

  scrollToBottom(chatMessages);

  // Inicializar resaltado de sintaxis mejorado
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightElement(block);

    // Añadir botones para copiar código
    const codeContainer = block.parentNode;
    const codeLanguage = block.className.replace('language-', '');

    // Crear un contenedor para el encabezado del código
    const codeHeader = document.createElement('div');
    codeHeader.className = 'code-header';
    codeHeader.innerHTML = `
      <span class="code-language">${codeLanguage}</span>
      <div class="code-actions">
        <button class="code-action-btn" onclick="copyCode(this)">
          <i class="bi bi-clipboard"></i> Copiar
        </button>
      </div>
    `;

    // Convertir pre en un código con encabezado
    codeContainer.classList.add('code-block');
    codeContainer.parentNode.insertBefore(codeHeader, codeContainer);
  });

  return messageElement;
}

// Función principal para inicializar el chat
function initializeChat() {
  const chatContainer = document.getElementById('chat-container');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');
  const agentSelector = document.getElementById('agent-selector');
  const connectionStatus = document.getElementById('connection-status');

  console.log("Inicializando chat con nueva configuración");

  // Inicializar Socket.IO
  socket = io({
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000,
    reconnectionDelayMax: 5000
  });

  // Configurar eventos de Socket.IO
  socket.on('connect', function() {
    console.log('Conexión Socket.IO establecida');
    connectionStatus.className = 'connection-status connected';
    connectionStatus.title = 'Conectado al servidor';
    addSystemMessage('Conexión establecida con el servidor');
  });

  socket.on('disconnect', function() {
    console.log('Conexión Socket.IO perdida');
    connectionStatus.className = 'connection-status disconnected';
    connectionStatus.title = 'Desconectado del servidor';
    addSystemMessage('Conexión con el servidor perdida. Intentando reconectar...');
  });

  socket.on('connect_error', function(error) {
    console.error('Error de conexión Socket.IO:', error);
    connectionStatus.className = 'connection-status disconnected';
    connectionStatus.title = 'Error de conexión';
    addSystemMessage('Error de conexión con el servidor. Intentando reconectar...');
  });

  socket.on('connecting', function() {
    console.log('Intentando conectar con Socket.IO');
    connectionStatus.className = 'connection-status connecting';
    connectionStatus.title = 'Conectando...';
  });

  socket.on('assistant_message', function(data) {
    console.log('Mensaje recibido del asistente:', data);
    removeLoadingMessage();

    // Restablecer el botón de envío
    if (sendButton) {
      sendButton.disabled = false;
      sendButton.classList.remove('btn-ripple');
      sendButton.innerHTML = '<i class="bi bi-send"></i>';
    }

    // Obtener el agente activo
    const activeAgent = window.app && window.app.activeAgent ? window.app.activeAgent : 
                        window.SPECIALIZED_AGENTS[data.agent] || window.SPECIALIZED_AGENTS.developer;

    // Mostrar la respuesta del agente
    addAgentMessage(data.message, activeAgent);

    // Procesar código HTML para previsualización
    processHtmlCodeForPreview(data.message);
  });

  // Cargar los agentes en el selector
  loadAgentSelector();

  // Verificar si hay un mensaje en la URL (enviado desde el corrector de código)
  checkMessageFromUrl(chatInput);

  // Evento para enviar mensaje al hacer clic en el botón
  sendButton.addEventListener('click', function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (message) {
      console.log("Enviando mensaje desde botón:", message);
      sendMessage(message);
      chatInput.value = '';
      // Restablecer altura después de enviar
      chatInput.style.height = 'auto';
    }
  });

  // Permitir enviar con Enter (excepto con Shift+Enter para nueva línea)
  chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendButton.click();
    }
  });

  // Autoajustar altura del textarea al escribir
  chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });

  // Si se recibió un mensaje de la URL, ajustar la altura inicial
  if (chatInput.value) {
    chatInput.style.height = 'auto';
    chatInput.style.height = (chatInput.scrollHeight) + 'px';
  }

  // Evento para cambiar de agente
  agentSelector.addEventListener('change', function() {
    const selectedAgentId = agentSelector.value;
    setActiveAgent(selectedAgentId);
  });

  // Inicializar detección de comandos de creación de páginas
  initCreationCommandDetection();
}

// Cargar los agentes en el selector
function loadAgentSelector() {
  const agentSelector = document.getElementById('agent-selector');
  if (!agentSelector) return; // Prevenir errores si el elemento no existe

  // Limpiar el selector actual
  agentSelector.innerHTML = '';

  // Verificar que SPECIALIZED_AGENTS está disponible
  if (typeof window.SPECIALIZED_AGENTS === 'undefined') {
    console.error("Error: SPECIALIZED_AGENTS no está definido");
    // Usar agentes predefinidos básicos si no están disponibles
    window.SPECIALIZED_AGENTS = {
      developer: {
        id: 'developer',
        name: 'Agente de Desarrollo',
        icon: 'bi-code-slash',
        description: 'Experto en optimización y edición de código en tiempo real',
        capabilities: ['Corrección de código', 'Optimización', 'Desarrollo']
      },
      architect: {
        id: 'architect',
        name: 'Agente de Arquitectura',
        icon: 'bi-diagram-3',
        description: 'Diseñador de arquitecturas escalables',
        capabilities: ['Diseño de sistemas', 'Planificación', 'Estructura']
      }
    };
  }

  // Crear opciones HTML directamente para mejor rendimiento
  let optionsHTML = '';

  // Opción por defecto (Developer)
  optionsHTML += `<option value="developer" selected>Agente de Desarrollo</option>`;

  // Añadir el resto de agentes
  for (const agentId in window.SPECIALIZED_AGENTS) {
    if (agentId !== 'developer') {
      const agent = window.SPECIALIZED_AGENTS[agentId];
      optionsHTML += `<option value="${agentId}">${agent.name}</option>`;
    }
  }

  // Insertar todas las opciones de una vez (mejor rendimiento)
  agentSelector.innerHTML = optionsHTML;
}

// Establecer el agente activo
function setActiveAgent(agentId) {
  // Asegurarse de que SPECIALIZED_AGENTS está definido
  if (typeof window.SPECIALIZED_AGENTS === 'undefined') {
    console.error("Error: SPECIALIZED_AGENTS no está definido");
    return;
  }

  // Obtener el agente seleccionado o usar el agente desarrollador por defecto
  window.app = window.app || {};
  window.app.activeAgent = window.SPECIALIZED_AGENTS[agentId] || window.SPECIALIZED_AGENTS.developer;

  // Actualizar el valor de los selectores
  const agentSelector = document.getElementById('agent-selector');

  if (agentSelector) {
    agentSelector.value = agentId;
  }

  // Actualizar la descripción del agente
  updateAgentDescription(window.app.activeAgent);

  // Actualizar el icono del avatar
  updateAgentAvatar(window.app.activeAgent);

  // Añadir mensaje informativo al chat
  addSystemMessage(`Has cambiado al <strong>${window.app.activeAgent.name}</strong>. Este agente se especializa en: ${window.app.activeAgent.description}.`);
}

// Actualizar el avatar del agente
function updateAgentAvatar(agent) {
  const agentAvatar = document.querySelector('.agent-icon i');
  if (agentAvatar) {
    agentAvatar.className = `bi ${agent.icon}`;
  }
}

// Actualizar la descripción del agente
function updateAgentDescription(agent) {
  const agentDescription = document.getElementById('agent-description');
  const agentCapabilities = document.getElementById('agent-capabilities');
  const agentTitle = document.querySelector('.agent-details h5');

  if (agentDescription && agentCapabilities) {
    agentDescription.textContent = agent.description;
    if (agentTitle) {
      agentTitle.textContent = agent.name;
    }

    // Mostrar capacidades
    agentCapabilities.innerHTML = '';
    agent.capabilities.forEach(capability => {
      const li = document.createElement('li');
      li.textContent = capability;
      agentCapabilities.appendChild(li);
    });
  }
}

// Inicializar detección de comandos de creación
function initCreationCommandDetection() {
  // Patrones para detectar comandos de creación (mejorados)
  window.app = window.app || {};
  window.app.creationPatterns = {
    page: /crea(r)?\s+(una)?\s+p[áa]gina|genera(r)?\s+(una)?\s+p[áa]gina|p[áa]gina\s+de\s+ventas/i,
    component: /crea(r)?\s+(un)?\s+componente|genera(r)?\s+(un)?\s+componente/i,
    form: /crea(r)?\s+(un)?\s+formulario|genera(r)?\s+(un)?\s+formulario/i
  };

  // Almacenar información de conversación contextual
  window.app.conversationState = {
    hasColorPreference: false,
    colorPreference: '',
    hasStyleInfo: false,
    styleInfo: '',
    hasContentInfo: false,
    contentInfo: '',
    creationMode: false,
    creationStep: 0,
    lastInstructionType: '',
    pendingActions: [],
    creationInProgress: false,
    messageHistory: []
  };
}

// Enviar mensaje al backend - Versión mejorada con Socket.IO
function sendMessage(message) {
  // Validar que haya un mensaje
  if (!message || message.trim() === '') {
    return;
  }

  // Añadir clase al botón de envío para mostrar animación
  const sendButton = document.getElementById('send-button');
  if (sendButton) {
    sendButton.classList.add('btn-ripple');
    sendButton.disabled = true;

    // Mostrar spinner en el botón
    sendButton.innerHTML = '<div class="spinner spinner-sm"></div>';
  }

  // Añadir mensaje del usuario al chat con animación
  const userMessageElement = addUserMessage(message);
  if (userMessageElement) {
    userMessageElement.classList.add('slide-in-up');
  }

  // Mostrar indicador de carga con estilo futurista
  addLoadingMessage();

  // Obtener información del agente y modelo seleccionados
  const agentSelector = document.getElementById('agent-selector');
  const modelSelect = document.getElementById('model-select');
  const documentSelector = document.getElementById('document-selector');

  // Preparar datos para enviar
  const data = {
    message: message,
    agent: agentSelector ? agentSelector.value : 'developer',
    model: modelSelect ? modelSelect.value : 'openai',
    document: documentSelector ? documentSelector.value : '',
    conversation_state: window.app.conversationState
  };

  console.log("Enviando mensaje a través de Socket.IO:", data);

  // Enviar mensaje a través de Socket.IO
  socket.emit('user_message', data);

  // Actualizar el estado de la conversación
  const lowerMsg = message.toLowerCase();
  if (lowerMsg.includes('página') || lowerMsg.includes('pagina') || lowerMsg.includes('web')) {
    window.app.conversationState.creationMode = true;
    window.app.conversationState.lastInstructionType = 'page';

    // Detectar preferencias de estilo y color
    if (lowerMsg.includes('color') || lowerMsg.includes('estilo') || lowerMsg.includes('diseño')) {
      window.app.conversationState.hasStyleInfo = true;

      if (lowerMsg.includes('pastel')) {
        window.app.conversationState.hasColorPreference = true;
        window.app.conversationState.colorPreference = 'pastel';
      } else if (lowerMsg.includes('moderna') || lowerMsg.includes('moderno')) {
        window.app.conversationState.hasStyleInfo = true;
        window.app.conversationState.styleInfo = 'moderna';
      }
    }
  }

  // Guardar historial de mensajes
  window.app.conversationState.messageHistory.push({
    role: 'user',
    content: message,
    timestamp: new Date().toISOString()
  });
}

// Funcionalidad para cargar documentos
function loadAvailableDocuments() {
  fetch('/api/documents/list')
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const documentSelector = document.getElementById('document-selector');
      // Limpiar opciones existentes excepto la primera (Sin documento)
      while (documentSelector.options.length > 1) {
        documentSelector.remove(1);
      }

      // Añadir documentos disponibles
      data.documents.forEach(doc => {
        const option = document.createElement('option');
        option.value = doc.filename;
        option.textContent = doc.filename;
        documentSelector.appendChild(option);
      });
    }
  })
  .catch(error => {
    console.error('Error al cargar documentos:', error);
  });
}

// Formatear tamaño de archivo
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
  else return (bytes / 1073741824).toFixed(1) + ' GB';
}

// Inicializar funcionalidad de documentos
function initializeDocumentFeatures() {
  // Cargar documentos disponibles
  loadAvailableDocuments();

  // Configurar selector de documentos
  const documentSelector = document.getElementById('document-selector');
  if (documentSelector) {
    documentSelector.addEventListener('change', function() {
      updateDocumentInfo(this.value);
    });
  }
}

// Actualizar información del documento seleccionado
function updateDocumentInfo(filename) {
  if (!filename) return;

  fetch(`/api/documents/info/${encodeURIComponent(filename)}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      addSystemMessage(`Documento seleccionado: <strong>${filename}</strong>`);
    }
  })
  .catch(error => {
    console.error('Error al obtener información del documento:', error);
  });
}

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
  // Configuración de agentes especializados
  window.SPECIALIZED_AGENTS = {
    developer: {
      id: 'developer',
      name: 'Agente de Desarrollo',
      icon: 'bi-code-slash',
      description: 'Experto en optimización y edición de código en tiempo real',
      capabilities: [
        'Corrección y refactorización de código',
        '