{% extends "base.html" %}

{% block title %}CODESTORM - Chat with Specialized Agent{% endblock %}

{% block extra_css %}
<!-- Google Fonts - Optimized Loading -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<!-- Highlight.js for Syntax Highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<style>
/* General Styles */
.chat-interface {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    max-width: 100%;
}

.chat-header {
    padding: 15px;
    background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
}

.chat-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: rgba(9, 20, 40, 0.7);
}

.chat-input-area {
    display: flex;
    padding: 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.input-addons {
    display: flex;
    gap: 10px;
    margin-right: 10px;
}

.chat-input-wrapper {
    flex: 1;
    position: relative;
}

.chat-input {
    width: 100%;
    border: 1px solid rgba(255, 215, 0, 0.2);
    background-color: rgba(9, 20, 40, 0.8);
    color: #fff;
    padding: 12px 15px;
    border-radius: 8px;
    resize: none;
    font-family: 'Inter', sans-serif;
    height: 50px;
    max-height: 150px;
    overflow-y: auto;
    transition: all 0.3s ease;
}

.chat-input:focus {
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    outline: none;
}

.chat-buttons {
    display: flex;
    gap: 10px;
    margin-left: 10px;
}

.action-button {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    color: #FFC107;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    background: linear-gradient(135deg, #0A2149 0%, #0c1e3a 100%);
}

.action-button:active {
    transform: translateY(1px);
}

.action-button i {
    font-size: 1.2rem;
}

.send-button {
    background: linear-gradient(135deg, #0c1e3a 0%, #0A2149 100%);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.send-button:hover {
    background: linear-gradient(135deg, #0c2657 0%, #0c2657 100%);
    border-color: rgba(255, 215, 0, 0.5);
}

.file-upload-button, .voice-button {
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Chat Messages */
.chat-message {
    margin-bottom: 20px;
    max-width: 90%;
    animation: fadeIn 0.3s ease-out;
}

.user-message {
    margin-left: auto;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    border-radius: 12px 12px 2px 12px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.agent-message {
    margin-right: auto;
    background: linear-gradient(135deg, #091428 0%, #0A2149 100%);
    border-radius: 12px 12px 12px 2px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(100, 149, 237, 0.2);
}

.system-message {
    margin: 10px auto;
    background-color: rgba(10, 33, 73, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    max-width: 90%;
    border: 1px solid rgba(255, 215, 0, 0.1);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.message-sender {
    font-weight: 600;
    color: #FFC107;
}

.message-time {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.message-content {
    color: #fff;
    line-height: 1.5;
}

.message-content p {
    margin-bottom: 1rem;
}

.message-content p:last-child {
    margin-bottom: 0;
}

/* Agent and Model Selectors */
.selector-section {
    background: linear-gradient(180deg, rgba(9, 20, 40, 0.8) 0%, rgba(10, 33, 73, 0.8) 100%);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    border: 1px solid rgba(255, 215, 0, 0.15);
}

.selector-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    margin-right: 10px;
    white-space: nowrap;
}

.selector-dropdown {
    flex: 1;
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 5px;
    color: #fff;
    padding: 5px 10px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.selector-dropdown:focus {
    border-color: rgba(255, 215, 0, 0.5);
    outline: none;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
}

.agent-info-panel {
    display: flex;
    background: linear-gradient(135deg, rgba(9, 20, 40, 0.6) 0%, rgba(10, 33, 73, 0.6) 100%);
    border-radius: 8px;
    padding: 12px;
    margin: 0 15px 15px;
    border: 1px solid rgba(255, 215, 0, 0.15);
    align-items: center;
}

.agent-icon {
    width: 50px;
    height: 50px;
    border-radius: 25px;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFC107;
    font-size: 1.5rem;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
    margin-right: 15px;
    flex-shrink: 0;
}

.agent-details {
    flex: 1;
}

.agent-name {
    font-weight: 600;
    color: #FFC107;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.agent-description {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin-bottom: 0;
}

/* Code */
pre {
    background-color: #282c34;
    border-radius: 8px;
    padding: 15px;
    overflow-x: auto;
    margin: 10px 0;
    position: relative;
}

pre code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #21252b;
    padding: 8px 15px;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #181a1f;
    font-family: 'Inter', sans-serif;
    margin-top: 10px;
}

.code-language {
    font-size: 0.8rem;
    color: #abb2bf;
    font-weight: 600;
}

.code-buttons {
    display: flex;
    gap: 10px;
}

.code-button {
    background-color: transparent;
    border: none;
    color: #abb2bf;
    cursor: pointer;
    padding: 2px 5px;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.code-button:hover {
    color: #fff;
}

/* File Upload Button */
.file-input {
    display: none;
}

/* Loading Indicator */
.loading-animation {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    gap: 8px;
}

.loading-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 215, 0, 0.6);
    animation: loadingAnimation 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

@keyframes loadingAnimation {
    0%, 80%, 100% {
        transform: scale(0);
    }
    40% {
        transform: scale(1);
    }
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Inline Code Styles */
.inline-code {
    font-family: 'JetBrains Mono', monospace;
    background-color: rgba(40, 44, 52, 0.5);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #e6e6e6;
}

/* Link Styles */
.chat-link {
    color: #3498db;
    text-decoration: none;
    border-bottom: 1px dotted #3498db;
    transition: all 0.2s ease;
}

.chat-link:hover {
    color: #2980b9;
    border-bottom: 1px solid #2980b9;
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-controls {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
    }

    .selector-section {
        width: 100%;
    }

    .agent-info-panel {
        flex-direction: column;
        text-align: center;
    }

    .agent-icon {
        margin: 0 auto 10px;
    }

    .chat-input-area {
        flex-direction: column;
        gap: 10px;
    }

    .input-addons {
        width: 100%;
        justify-content: space-between;
    }

    .chat-buttons {
        width: 100%;
        justify-content: space-between;
        margin-left: 0;
    }

    .chat-interface {
        height: calc(100vh - 280px);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Redesigned Chat Interface -->
        <div class="col-12">
            <div class="card card-futuristic">
                <!-- Header with Title -->
                <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-cpu me-2"></i>Chat with Specialized Agent</span>
                </div>

                <!-- Chat Content -->
                <div class="card-body p-0">
                    <!-- Top Control Panel -->
                    <div class="chat-controls">
                        <!-- Model Selector -->
                        <div class="selector-section">
                            <span class="selector-label">AI Model:</span>
                            <select id="model-select" class="selector-dropdown">
                                <option value="openai" selected>OpenAI (GPT-4o)</option>
                                <option value="anthropic">Anthropic (Claude)</option>
                                <option value="gemini">Google (Gemini)</option>
                            </select>
                        </div>

                        <!-- Agent Selector -->
                        <div class="selector-section">
                            <span class="selector-label">Agent:</span>
                            <select id="agent-selector" class="selector-dropdown">
                                <option value="developer" selected>Development Agent</option>
                                <option value="architect">Software Architect</option>
                                <option value="advanced">Advanced Specialist</option>
                                <option value="general">General Assistant</option>
                            </select>
                        </div>

                        <!-- Document Selector -->
                        <div class="selector-section">
                            <span class="selector-label">Document:</span>
                            <select id="document-selector" class="selector-dropdown">
                                <option value="" selected>No document</option>
                                <!-- Dynamically loaded documents will appear here -->
                            </select>
                            <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#documentModal">
                                <i class="bi bi-file-earmark-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Agent Information -->
                    <div class="agent-info-panel">
                        <div class="agent-icon">
                            <i class="bi bi-code-slash" id="agent-icon"></i>
                        </div>
                        <div class="agent-details">
                            <h5 class="agent-name" id="agent-name">Development Agent</h5>
                            <p class="agent-description" id="agent-description">Expert in real-time code optimization and editing</p>
                        </div>
                    </div>

                    <!-- Message Container -->
                    <div class="chat-interface">
                        <div class="chat-messages-container" id="chat-messages">
                            <!-- System Welcome Message -->
                            <div class="chat-message system-message">
                                <div class="message-content">
                                    <p>¡Bienvenido al chat especializado de CODESTORM! Estás hablando con el <strong>Agente de Desarrollo</strong>, un experto en optimización y edición de código en tiempo real.</p>
                                </div>
                            </div>
                            <!-- Dynamic messages will be added here -->
                        </div>

                        <!-- Input Area and Buttons -->
                        <div class="chat-input-area">
                            <div class="input-addons">
                                <button type="button" class="action-button file-upload-button" id="file-button" title="Upload file">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                <input type="file" id="file-input" class="file-input" multiple>

                                <button type="button" class="action-button voice-button" id="voice-button" title="Voice recognition">
                                    <i class="bi bi-mic"></i>
                                </button>
                            </div>

                            <div class="chat-input-wrapper">
                                <textarea id="chat-input" class="chat-input" placeholder="Escribe tu mensaje aquí... Por ejemplo: 'Crea una página de ventas para productos tecnológicos'" rows="1"></textarea>
                            </div>

                            <div class="chat-buttons">
                                <button type="button" class="action-button send-button" id="send-button">
                                    <i class="bi bi-send"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview (initially hidden) -->
        <div class="col-12 mt-4" id="preview-section" style="display: none;">
            <div class="card card-futuristic">
                <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-window me-2"></i>Preview</span>
                    <div>
                        <button id="toggle-preview" class="btn btn-sm btn-futuristic">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="device-toggle-buttons py-2">
                        <button class="device-toggle-btn active" data-device="desktop">
                            <i class="bi bi-laptop"></i> Desktop
                        </button>
                        <button class="device-toggle-btn" data-device="tablet">
                            <i class="bi bi-tablet"></i> Tablet
                        </button>
                        <button class="device-toggle-btn" data-device="mobile">
                            <i class="bi bi-phone"></i> Mobile
                        </button>
                    </div>

                    <div class="preview-container" id="preview-container">
                        <div class="preview-header">
                            <div class="preview-controls">
                                <div class="control-btn control-close"></div>
                                <div class="control-btn control-minimize"></div>
                                <div class="control-btn control-expand"></div>
                            </div>
                            <div class="preview-url">
                                <span>preview.html</span>
                            </div>
                        </div>
                        <iframe id="preview-iframe" class="preview-iframe" title="Preview"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Uploading Documents -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="documentModalLabel">Upload Document</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadDocumentForm">
                    <div class="mb-3">
                        <label for="documentFile" class="form-label">Select a document:</label>
                        <input type="file" class="form-control bg-dark text-light border-secondary" id="documentFile" required>
                        <div class="form-text text-light-50">
                            Supported formats: PDF, DOCX, HTML, MD, TXT, PY, JS, etc.
                        </div>
                    </div>
                    <div id="uploadStatus" class="mb-3"></div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Initialize global app object if it doesn't exist
window.app = window.app || {};
window.app.chat = window.app.chat || {};

// Socket.IO instance
let socket;

// Initialize chat functionality
function initializeChat() {
    console.log("Initializing chat interface...");

    // Initialize socket connection
    initializeSocketConnection();

    // Set up UI event listeners
    setupEventListeners();

    // Add initial system message if not already present
    if (document.querySelectorAll('.chat-message').length <= 1) {
        addSystemMessage("Connection established. Ready to respond to your queries.");
    }
}

// Initialize Socket.IO connection
function initializeSocketConnection() {
    try {
        // Connect to Socket.IO server
        console.log("Establishing connection to the server...");

        // Initialize socket (adjust URL if needed)
        const serverUrl = window.location.protocol + '//' + window.location.host;
        socket = io(serverUrl, {
            path: '/socket.io',
            transports: ['websocket', 'polling']
        });

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connection established with the server');
            addSystemMessage("Connection established with the server.");
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            addSystemMessage("⚠️ Disconnected from server. Attempting to reconnect...");
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            addSystemMessage("❌ Connection error with the server. Check your internet connection.");
        });

        socket.on('message', (data) => {
            console.log('Message received:', data);
            handleReceivedMessage(data);
        });

        socket.on('agent_response', (data) => {
            console.log('Agent response received:', data);
            addAgentMessage(data.content);
            hideLoadingIndicator();
        });

        // Diagnostic test to verify connection
        setTimeout(() => {
            console.log("Performing connection test...");
            socket.emit('ping', { time: new Date().toISOString() });
            // Socket.IO emit doesn't return a promise, so we can't use .catch
        }, 1000);

    } catch (error) {
        console.error("Error initializing Socket.IO:", error);
        addSystemMessage("❌ Error establishing connection. " + error.message);

        // Check for specific issues
        if (error.message) {
            if (error.message.includes('NetworkError') || error.message.includes('CORS')) {
                console.warn('Possible CORS or network issue detected');
                addSystemMessage('Note: Possible CORS or network issue. Check server configuration.');
            }

            if (error.message.includes('socket.io')) {
                console.warn('Socket.IO issue detected');
                addSystemMessage('Note: Ensure Socket.IO is correctly installed and configured on the server.');
            }
        }
    }
}

// Set up event listeners
function setupEventListeners() {
    const sendButton = document.getElementById('send-button');
    const chatInput = document.getElementById('chat-input');
    const agentSelector = document.getElementById('agent-selector');
    const modelSelector = document.getElementById('model-select');

    // Send button click event
    sendButton.addEventListener('click', () => {
        sendMessage();
    });

    // Enter key press in input field
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Agent selection change
    agentSelector.addEventListener('change', () => {
        const agentId = agentSelector.value;
        setActiveAgent(agentId);
    });

    // Model selection change
    modelSelector.addEventListener('change', () => {
        const modelId = modelSelector.value;
        addSystemMessage(`AI Model changed to: ${modelId}`);
    });
}

// Set active agent
function setActiveAgent(agentId) {
    const agents = window.SPECIALIZED_AGENTS || {};
    const agent = agents[agentId];

    if (!agent) {
        console.error(`Agent "${agentId}" not found`);
        return;
    }

    // Update agent info in UI
    document.getElementById('agent-name').textContent = agent.name;
    document.getElementById('agent-description').textContent = agent.description;

    // Update agent icon
    const iconElement = document.getElementById('agent-icon');
    iconElement.className = '';
    iconElement.classList.add('bi', agent.icon);

    // Send system message about agent change
    addSystemMessage(`Agent changed to: ${agent.name}`);

    // Notify server about agent change
    if (socket && socket.connected) {
        socket.emit('change_agent', { agent_id: agentId });
    }

    console.log(`Agent changed to: ${agent.name} (${agentId})`);
}

// Send message to server
function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;

    // Clear input
    input.value = '';
    input.style.height = 'auto';

    // Add message to UI
    addUserMessage(message);

    // Show loading indicator
    showLoadingIndicator();

    // Get current agent and model
    const agentId = document.getElementById('agent-selector').value;
    const modelId = document.getElementById('model-select').value;
    const documentId = document.getElementById('document-selector').value;

    // Create message payload
    const payload = {
        content: message,
        agent_id: agentId,
        model_id: modelId,
        document_id: documentId || null,
        timestamp: new Date().toISOString()
    };

    // Send to server if socket is available
    if (socket && socket.connected) {
        console.log('Sending message to server:', payload);
        socket.emit('user_message', payload);
    } else {
        console.error('Socket not available or not connected');
        handleSocketError();

        // Fallback to AJAX if socket is not available
        sendMessageFallback(payload);
    }
}

// Fallback method for sending messages using AJAX
function sendMessageFallback(payload) {
    console.log('Using fallback method to send message (AJAX)');

    fetch('/api/chat/message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response received (AJAX):', data);
        if (data.success) {
            addAgentMessage(data.response);
        } else {
            addSystemMessage("❌ Error: " + (data.error || "Unable to process your message"));
        }
        hideLoadingIndicator();
    })
    .catch(error => {
        console.error('AJAX request error:', error);
        addSystemMessage("❌ Connection error: Unable to send message");
        hideLoadingIndicator();
    });
}

// Handle received message from server
function handleReceivedMessage(data) {
    if (data.type === 'agent') {
        addAgentMessage(data.content);
    } else if (data.type === 'system') {
        addSystemMessage(data.content);
    }

    hideLoadingIndicator();
}

// Add user message to chat
function addUserMessage(message) {
    const messagesContainer = document.getElementById('chat-messages');
    const time = getCurrentTime();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message user-message';

    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-sender">You</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${formatMessage(message)}</div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom(messagesContainer);
}

// Add agent message to chat
function addAgentMessage(message) {
    const messagesContainer = document.getElementById('chat-messages');
    const agentName = document.getElementById('agent-name').textContent;
    const time = getCurrentTime();

    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message agent-message';

    // Process message content (handles code blocks, markdown, etc.)
    const formattedContent = formatMessage(message);

    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-sender">${agentName}</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${formattedContent}</div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom(messagesContainer);

    // Initialize code highlighting and add copy buttons
    processCodeBlocks(messageDiv);
}

// Add system message to chat
function addSystemMessage(message) {
    const messagesContainer = document.getElementById('chat-messages');

    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message system-message';

    messageDiv.innerHTML = `
        <div class="message-content">${message}</div>
    `;

    messagesContainer.appendChild(messageDiv);
    scrollToBottom(messagesContainer);
}

// Format message text (convert code blocks, etc.)
function formatMessage(text) {
    if (!text) return '';

    // Escape HTML
    text = escapeHtml(text);

    // Replace code blocks with formatted HTML
    text = text.replace(/```([\w-]*)\n([\s\S]*?)```/g, function(match, language, code) {
        return `
            <div class="code-header">
                <span class="code-language">${language || 'code'}</span>
                <div class="code-buttons">
                    <button class="code-button copy-code-btn" title="Copy code">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                </div>
            </div>
            <pre><code class="${language || ''}">${code}</code></pre>
        `;
    });

    // Replace inline code
    text = text.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');

    // Replace line breaks
    text = text.replace(/\n/g, '<br>');

    return text;
}

// Process code blocks in message
function processCodeBlocks(messageElement) {
    // Initialize highlighting on all code blocks
    const codeBlocks = messageElement.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        hljs.highlightElement(block);
    });

    // Add copy functionality to code blocks
    const copyButtons = messageElement.querySelectorAll('.copy-code-btn');
    copyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const codeBlock = this.closest('.message-content').querySelector('pre code');
            copyToClipboard(codeBlock.textContent);

            // Change button text temporarily
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-check"></i> Copied';

            setTimeout(() => {
                this.innerHTML = originalText;
            }, 2000);
        });
    });
}

// Copy text to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(
        () => console.log('Text copied to clipboard'),
        err => console.error('Error copying text: ', err)
    );
}

// Show loading indicator
function showLoadingIndicator() {
    const messagesContainer = document.getElementById('chat-messages');

    // Remove existing loading indicator if any
    const existingIndicator = document.getElementById('loading-indicator');
    if (existingIndicator) {
        existingIndicator.remove();
    }

    // Create loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-indicator';
    loadingDiv.className = 'loading-animation';
    loadingDiv.innerHTML = `
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
        <div class="loading-dot"></div>
    `;

    messagesContainer.appendChild(loadingDiv);
    scrollToBottom(messagesContainer);
}

// Hide loading indicator
function hideLoadingIndicator() {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (loadingIndicator) {
        loadingIndicator.remove();
    }
}

// Handle socket connection errors
function handleSocketError() {
    console.warn('Socket.IO connection issues');
    addSystemMessage("⚠️ Connection issues. Using fallback method.");
}

// Process HTML code for preview
function processHtmlCodeForPreview(message) {
    // Extract HTML content from code blocks
    const htmlRegex = /```html([\s\S]*?)```/g;
    const htmlMatches = message.match(htmlRegex);

    if (htmlMatches && htmlMatches.length > 0) {
        // Extract the HTML from the first match
        const htmlCode = htmlMatches[0].replace(/```html/, '').replace(/```$/, '').trim();
        return htmlCode;
    }

    return null;
}

// Show preview of HTML
function showHtmlPreview(htmlContent) {
    const previewSection = document.getElementById('preview-section');
    const previewIframe = document.getElementById('preview-iframe');

    if (!htmlContent) return;

    // Create a blob with the HTML content
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);

    // Set the iframe source
    previewIframe.src = url;

    // Show the preview section
    previewSection.style.display = 'block';

    // Clean up the URL object when no longer needed
    previewIframe.onload = function() {
        URL.revokeObjectURL(url);
    };
}

// Function to escape HTML for safe display
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Function to get current time for messages
function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Function to scroll chat container to bottom
function scrollToBottom(element) {
    if (element) {
        element.scrollTop = element.scrollHeight;
    }
}

// Make functions globally available
window.initializeChat = initializeChat;
window.setActiveAgent = setActiveAgent;
window.addSystemMessage = addSystemMessage;

// Document Features
function initializeDocumentFeatures() {
    // Load available documents
    loadAvailableDocuments();

    // Set up document upload events
    const uploadDocumentForm = document.getElementById('uploadDocumentForm');
    if (uploadDocumentForm) {
        uploadDocumentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            uploadDocument();
        });
    }

    // Set up document selector
    const documentSelector = document.getElementById('document-selector');
    if (documentSelector) {
        documentSelector.addEventListener('change', function() {
            updateDocumentInfo(this.value);
        });
    }

    // Set up document remove button
    const documentRemoveBtn = document.querySelector('.document-remove');
    if (documentRemoveBtn) {
        documentRemoveBtn.addEventListener('click', function() {
            const selectedDoc = document.getElementById('document-selector').value;
            if (selectedDoc) {
                deleteDocument(selectedDoc);
            }
        });
    }
}

// Load available documents
function loadAvailableDocuments() {
    fetch('/api/documents/list')
        .then(response => {
            if (!response.ok) {
                console.warn('Error in server response:', response.status);
                return { success: false, error: response.statusText };
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const documentSelector = document.getElementById('document-selector');
                // Clear existing options except the first (No document)
                while (documentSelector && documentSelector.options.length > 1) {
                    documentSelector.remove(1);
                }

                // Add available documents
                if (documentSelector && data.documents) {
                    data.documents.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc.filename;
                        option.textContent = doc.filename;
                        documentSelector.appendChild(option);
                    });
                }
            } else {
                console.warn('Unexpected server response:', data);
            }
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            // Do not show error to user, just log it
        });
}

// Update information of the selected document
function updateDocumentInfo(filename) {
    const documentDetails = document.querySelector('.document-details');
    const documentStatus = document.querySelector('.document-status');

    if (!filename || !documentDetails || !documentStatus) {
        if (documentDetails) documentDetails.style.display = 'none';
        if (documentStatus) documentStatus.innerHTML = '<small>Select a document to use as context in the conversation.</small>';
        return;
    }

    fetch(`/api/documents/info/${encodeURIComponent(filename)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const doc = data.document;

                // Show document details
                document.querySelector('.document-type').textContent = doc.type.toUpperCase().substring(1);
                document.querySelector('.document-size').textContent = formatFileSize(doc.size);
                documentDetails.style.display = 'flex';

                // Update status
                const wordCount = doc.word_count ? doc.word_count.toLocaleString() : '?';
                documentStatus.innerHTML = `
                    <small>Document loaded: <strong>${doc.filename}</strong> (${wordCount} words)</small>
                    <div class="mt-1 text-success">
                        <small><i class="bi bi-check-circle"></i> Ready to use as context</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error getting document information:', error);
            documentDetails.style.display = 'none';
            documentStatus.innerHTML = '<small class="text-danger">Error loading document information.</small>';
        });
}

// Upload document
function uploadDocument() {
    const fileInput = document.getElementById('documentFile');
    if (!fileInput.files || fileInput.files.length === 0) {
        showUploadError('Select a file to upload.');
        return;
    }

    const allowedTypes = ['.pdf', '.docx', '.doc', '.html', '.htm', '.md', '.txt', '.py', '.js','.css', '.json', '.csv', '.xml', '.yml', '.yaml', '.pptx', '.epub'];
    const file = fileInput.files[0];
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();

    if (!allowedTypes.includes(fileExt)) {
        showUploadError(`Unsupported file type. Supported formats: ${allowedTypes.join(', ')}`);
        return;
    }

    // Show upload status
    const uploadStatus = document.getElementById('uploadStatus');
    uploadStatus.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Uploading document...';

    const formData = new FormData();
    formData.append('file', file);

    fetch('/api/documents/upload', {
        method: 'POST',
        body: formData
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update document list
                loadAvailableDocuments();

                // Show success message
                uploadStatus.innerHTML = `<div class="text-success"><i class="bi bi-check-circle"></i> Document uploaded successfully.</div>`;

                // Select the newly uploaded document
                setTimeout(() => {
                    const documentSelector = document.getElementById('document-selector');
                    documentSelector.value = data.document.filename;
                    updateDocumentInfo(data.document.filename);

                    // Close modal after 1 second
                    setTimeout(() => {
                        const documentModal = bootstrap.Modal.getInstance(document.getElementById('documentModal'));
                        documentModal.hide();
                        uploadStatus.innerHTML = '';
                        fileInput.value = '';
                    }, 1000);
                }, 500);
            } else {
                showUploadError(data.error || 'Error uploading document.');
            }
        })
        .catch(error => {
            console.error('Error uploading document:', error);
            showUploadError('Connection error while uploading document.');
        });
}

// Delete document
function deleteDocument(filename) {
    if (!confirm(`Are you sure you want to delete the document "${filename}"?`)) {
        return;
    }

    fetch(`/api/documents/delete/${encodeURIComponent(filename)}`, {
        method: 'DELETE'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update document list
                loadAvailableDocuments();

                // Clear selection
                document.getElementById('document-selector').value = '';
                updateDocumentInfo('');

                // Show message
                addSystemMessage(`The document "${filename}" has been deleted.`);
            } else {
                console.error('Error deleting document:', data.error);
                addSystemMessage(`Error deleting document: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error deleting document:', error);
            addSystemMessage('Connection error while deleting document.');
        });
}

// Show error in the upload form
function showUploadError(message) {
    const uploadStatus = document.getElementById('uploadStatus');
    if (uploadStatus) {
        uploadStatus.innerHTML = `<div class="text-danger"><i class="bi bi-exclamation-circle"></i> ${message}</div>`;
    }
}

// Format file size
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
    else return (bytes / 1073741824).toFixed(1) + ' GB';
}

// Initialize interface when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Specialized agents configuration
    window.SPECIALIZED_AGENTS = {
        developer: {
            id: 'developer',
            name: 'Agente de Desarrollo',
            icon: 'bi-code-slash',
            description: 'Experto en optimización y edición de código en tiempo real',
            capabilities: [
                'Corrección y refactorización de código',
                'Optimización de rendimiento',
                'Integración de frameworks y librerías',
                'Automatización de tareas',
                'Generación de código limpio'
            ]
        },
        architect: {
            id: 'architect',
            name: 'Arquitecto de Software',
            icon: 'bi-diagram-3',
            description: 'Diseñador de arquitecturas escalables y optimizadas',
            capabilities: [
                'Definición de estructura del proyecto',
                'Selección de tecnologías y frameworks',
                'Asesoría en elección de bases de datos',
                'Implementación de microservicios',
                'Planificación de UI/UX y patrones de diseño'
            ]
        },
        advanced: {
            id: 'advanced',
            name: 'Especialista Avanzado',
            icon: 'bi-braces',
            description: 'Experto en soluciones complejas e integraciones',
            capabilities: [
                'Desarrollo de soluciones avanzadas',
                'Integración con APIs externas',
                'Optimización de rendimiento',
                'Seguridad y encriptación',
                'Despliegue y configuración de servidores'
            ]
        },
        general: {
            id: 'general',
            name: 'Asistente General',
            icon: 'bi-chat-dots',
            description: 'Asistente versátil para consultas generales',
            capabilities: [
                'Respuesta a preguntas generales',
                'Orientación básica de desarrollo',
                'Ayuda con conceptos de programación',
                'Consejos de buenas prácticas',
                'Resolución de problemas comunes'
            ]
        }
    };

    console.log("Checking the availability of the initializeChat function...");
    if (typeof initializeChat === 'function') {
        console.log("initializeChat function available, initializing chat...");
        initializeChat();
        setActiveAgent('developer');
    } else {
        console.error("ERROR: The initializeChat function is not available");
        alert("Error loading the chat system. Please reload the page.");
    }
});

// Functionality to adjust textarea height
const chatInput = document.getElementById('chat-input');
chatInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight < 150 ? this.scrollHeight : 150) + 'px';
});

// Functionality for the file button
const fileButton = document.getElementById('file-button');
const fileInput = document.getElementById('file-input');

fileButton.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        const fileNames = Array.from(this.files).map(file => file.name).join(', ');
        chatInput.value += `\nSelected files: ${fileNames}`;
        chatInput.dispatchEvent(new Event('input'));
    }
});

// Basic voice button functionality
const voiceButton = document.getElementById('voice-button');
let recognition;

if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    voiceButton.addEventListener('click', function() {
        if (voiceButton.classList.contains('recording')) {
            recognition.stop();
            voiceButton.classList.remove('recording');
            voiceButton.style.backgroundColor = '';
        } else {
            recognition.start();
            voiceButton.classList.add('recording');
            voiceButton.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
        }
    });

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        chatInput.value += transcript;
        chatInput.dispatchEvent(new Event('input'));
    };

    recognition.onend = function() {
        voiceButton.classList.remove('recording');
        voiceButton.style.backgroundColor = '';
    };
} else {
    voiceButton.addEventListener('click', function() {
        alert('Voice recognition is not supported in this browser.');
    });
}

// Allow sending with Enter (except with Shift+Enter for new line)
chatInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('send-button').click();
    }
});

// Initialize document features
initializeDocumentFeatures();

// Toggle preview section
const togglePreviewBtn = document.getElementById('toggle-preview');
if (togglePreviewBtn) {
    togglePreviewBtn.addEventListener('click', function() {
        const previewSection = document.getElementById('preview-section');
        previewSection.style.display = 'none';
    });
}

console.log("Initialization complete. System ready.");
</script>
{% endblock %}