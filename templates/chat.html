{% extends "base.html" %}

{% block title %}CODESTORM - Chat con Agente Especializado{% endblock %}

{% block extra_css %}
<!-- Google Fonts - Carga optimizada -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

<!-- Highlight.js para resaltado de sintaxis -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

<!-- Socket.IO para comunicación en tiempo real -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

<style>
/* Estilos generales */
.chat-interface {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    max-width: 100%;
}

.chat-header {
    padding: 15px;
    background: linear-gradient(90deg, #091428 0%, #0A2149 100%);
    border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
}

.chat-controls {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: rgba(9, 20, 40, 0.7);
}

.chat-input-area {
    display: flex;
    padding: 15px;
    background-color: rgba(10, 33, 73, 0.5);
    border-top: 1px solid rgba(255, 215, 0, 0.1);
}

.input-addons {
    display: flex;
    gap: 10px;
    margin-right: 10px;
}

.chat-input-wrapper {
    flex: 1;
    position: relative;
}

.chat-input {
    width: 100%;
    border: 1px solid rgba(255, 215, 0, 0.2);
    background-color: rgba(9, 20, 40, 0.8);
    color: #fff;
    padding: 12px 15px;
    border-radius: 8px;
    resize: none;
    font-family: 'Inter', sans-serif;
    height: 50px;
    max-height: 150px;
    overflow-y: auto;
    transition: all 0.3s ease;
}

.chat-input:focus {
    border-color: rgba(255, 215, 0, 0.5);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
    outline: none;
}

.chat-buttons {
    display: flex;
    gap: 10px;
    margin-left: 10px;
}

.action-button {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    color: #FFC107;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    background: linear-gradient(135deg, #0A2149 0%, #0c1e3a 100%);
}

.action-button:active {
    transform: translateY(1px);
}

.action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.action-button i {
    font-size: 1.2rem;
}

.send-button {
    background: linear-gradient(135deg, #0c1e3a 0%, #0A2149 100%);
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.send-button:hover {
    background: linear-gradient(135deg, #0c2657 0%, #0c2657 100%);
    border-color: rgba(255, 215, 0, 0.5);
}

.file-upload-button, .voice-button {
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Mensajes del chat */
.chat-message {
    margin-bottom: 20px;
    max-width: 90%;
    animation: fadeIn 0.3s ease-out;
}

.user-message {
    margin-left: auto;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    border-radius: 12px 12px 2px 12px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.agent-message {
    margin-right: auto;
    background: linear-gradient(135deg, #091428 0%, #0A2149 100%);
    border-radius: 12px 12px 12px 2px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(100, 149, 237, 0.2);
}

.system-message {
    margin: 10px auto;
    background-color: rgba(10, 33, 73, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    max-width: 90%;
    border: 1px solid rgba(255, 215, 0, 0.1);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    text-align: center;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.message-sender {
    font-weight: 600;
    color: #FFC107;
}

.message-time {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.message-content {
    color: #fff;
    line-height: 1.5;
}

.message-content p {
    margin-bottom: 1rem;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.message-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
}

.message-agent, .message-user {
    display: flex;
    align-items: center;
    gap: 5px;
}

.copy-message {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.6);
    border-radius: 4px;
    padding: 2px 5px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-message:hover {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
}

/* Selector de Agentes y Modelos */
.selector-section {
    background: linear-gradient(180deg, rgba(9, 20, 40, 0.8) 0%, rgba(10, 33, 73, 0.8) 100%);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    margin-bottom: 5px;
    border: 1px solid rgba(255, 215, 0, 0.15);
}

.selector-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    margin-right: 10px;
    white-space: nowrap;
}

.selector-dropdown {
    flex: 1;
    background-color: rgba(9, 20, 40, 0.9);
    border: 1px solid rgba(255, 215, 0, 0.2);
    border-radius: 5px;
    color: #fff;
    padding: 5px 10px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.selector-dropdown:focus {
    border-color: rgba(255, 215, 0, 0.5);
    outline: none;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.2);
}

.agent-info-panel {
    display: flex;
    background: linear-gradient(135deg, rgba(9, 20, 40, 0.6) 0%, rgba(10, 33, 73, 0.6) 100%);
    border-radius: 8px;
    padding: 12px;
    margin: 0 15px 15px;
    border: 1px solid rgba(255, 215, 0, 0.15);
    align-items: center;
}

.agent-icon {
    width: 50px;
    height: 50px;
    border-radius: 25px;
    background: linear-gradient(135deg, #0A2149 0%, #091428 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #FFC107;
    font-size: 1.5rem;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
    margin-right: 15px;
    flex-shrink: 0;
}

.agent-details {
    flex: 1;
}

.agent-name {
    font-weight: 600;
    color: #FFC107;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.agent-description {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin-bottom: 0;
}

.agent-capabilities {
    margin-top: 8px;
    padding-left: 20px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
}

.agent-capabilities li {
    margin-bottom: 3px;
}

/* Código */
pre {
    background-color: #282c34;
    border-radius: 8px;
    padding: 15px;
    overflow-x: auto;
    margin: 10px 0;
    position: relative;
}

pre code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #21252b;
    padding: 8px 15px;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #181a1f;
    font-family: 'Inter', sans-serif;
    margin-top: 10px;
}

.code-language {
    font-size: 0.8rem;
    color: #abb2bf;
    font-weight: 600;
}

.code-buttons {
    display: flex;
    gap: 10px;
}

.code-button {
    background-color: transparent;
    border: none;
    color: #abb2bf;
    cursor: pointer;
    padding: 2px 5px;
    font-size: 0.8rem;
    transition: all 0.3s ease;
}

.code-button:hover {
    color: #fff;
}

/* Botón de carga de archivos */
.file-input {
    display: none;
}

/* Indicador de carga */
.loading-animation {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    gap: 8px;
}

.loading-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: rgba(255, 215, 0, 0.6);
    animation: loadingAnimation 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.loading-dot:nth-child(2) {
    animation-delay: -0.16s;
}

.loading-dot:nth-child(3) {
    animation-delay: -0.16s;
}

@keyframes loadingAnimation {
    0%, 80%, 100% {
    transform: scale(0);
    }
    40% {
    transform: scale(1);
    }
}

/* Animaciones */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* Estilos para código inline */
.inline-code {
    font-family: 'JetBrains Mono', monospace;
    background-color: rgba(40, 44, 52, 0.5);
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 0.9em;
    color: #e6e6e6;
}

/* Estilos para los enlaces */
.chat-link {
    color: #3498db;
    text-decoration: none;
    border-bottom: 1px dotted #3498db;
    transition: all 0.2s ease;
}

.chat-link:hover {
    color: #2980b9;
    border-bottom: 1px solid #2980b9;
}

/* Indicador de estado de conexión */
.connection-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.connection-status.connected {
    background-color: #4CAF50;
    box-shadow: 0 0 5px #4CAF50;
}

.connection-status.connecting {
    background-color: #FFC107;
    box-shadow: 0 0 5px #FFC107;
    animation: pulse 1s infinite;
}

.connection-status.disconnected {
    background-color: #F44336;
    box-shadow: 0 0 5px #F44336;
}

/* Typing indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    column-gap: 5px;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    float: left;
    margin: 0 1px;
    background-color: rgba(255, 215, 0, 0.5);
    display: block;
    border-radius: 50%;
    opacity: 0.4;
}

.typing-indicator span:nth-of-type(1) {
    animation: 1s blink infinite 0.3333s;
}

.typing-indicator span:nth-of-type(2) {
    animation: 1s blink infinite 0.6666s;
}

.typing-indicator span:nth-of-type(3) {
    animation: 1s blink infinite 0.9999s;
}

@keyframes blink {
    50% {
        opacity: 1;
    }
}

/* Shimmer effect */
.shimmer-effect {
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* Copy tooltip */
.copy-tooltip {
    position: absolute;
    top: -30px;
    right: 10px;
    background-color: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    animation: fadeIn 0.3s ease-out;
}

/* Responsivo */
@media (max-width: 768px) {
    .chat-controls {
    flex-direction: column;
    gap: 10px;
    padding: 10px;
    }

    .selector-section {
    width: 100%;
    }

    .agent-info-panel {
    flex-direction: column;
    text-align: center;
    }

    .agent-icon {
    margin: 0 auto 10px;
    }

    .chat-input-area {
    flex-direction: column;
    gap: 10px;
    }

    .input-addons {
    width: 100%;
    justify-content: space-between;
    }

    .chat-buttons {
    width: 100%;
    justify-content: space-between;
    margin-left: 0;
    }

    .chat-interface {
    height: calc(100vh - 280px);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
    <!-- Interfaz de Chat Rediseñada -->
    <div class="col-12">
    <div class="card card-futuristic">
    <!-- Cabecera con título -->
    <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
    <span><i class="bi bi-cpu me-2"></i>Chat con Agente Especializado</span>
    <div id="connection-status" class="connection-status" title="Estado de conexión"></div>
    </div>

    <!-- Contenido del chat -->
    <div class="card-body p-0">
    <!-- Panel de control superior -->
    <div class="chat-controls">
    <!-- Selector de Modelo -->
    <div class="selector-section">
    <span class="selector-label">Modelo de IA:</span>
    <select id="model-select" class="selector-dropdown">
    <option value="openai" selected>OpenAI (GPT-4o)</option>
    <option value="anthropic">Anthropic (Claude)</option>
    <option value="gemini">Google (Gemini)</option>
    </select>
    </div>

    <!-- Selector de Agente -->
    <div class="selector-section">
    <span class="selector-label">Agente:</span>
    <select id="agent-selector" class="selector-dropdown">
    <option value="developer" selected>Agente de Desarrollo</option>
    <option value="architect">Arquitecto de Software</option>
    <option value="advanced">Especialista Avanzado</option>
    <option value="general">Asistente General</option>
    </select>
    </div>

    <!-- Selector de Documentos -->
    <div class="selector-section">
    <span class="selector-label">Documento:</span>
    <select id="document-selector" class="selector-dropdown">
    <option value="" selected>Sin documento</option>
    <!-- Aquí se cargarán dinámicamente los documentos disponibles -->
    </select>
    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#documentModal">
    <i class="bi bi-file-earmark-plus"></i>
    </button>
    </div>
    </div>

    <!-- Información del agente seleccionado -->
    <div class="agent-info-panel">
    <div class="agent-icon">
    <i class="bi bi-code-slash" id="agent-icon"></i>
    </div>
    <div class="agent-details">
    <h5 class="agent-name" id="agent-name">Agente de Desarrollo</h5>
    <p class="agent-description" id="agent-description">Experto en optimización y edición de código en tiempo real</p>
    <ul class="agent-capabilities" id="agent-capabilities">
        <li>Corrección y refactorización de código</li>
        <li>Optimización de rendimiento</li>
        <li>Integración de frameworks y librerías</li>
    </ul>
    </div>
    </div>

    <!-- Contenedor de mensajes -->
    <div class="chat-interface">
    <div class="chat-messages-container" id="chat-messages">
    <!-- Mensaje de bienvenida del sistema -->
    <div class="chat-message system-message">
    <div class="message-content">
    <p>¡Bienvenido al chat especializado de CODESTORM! Estás hablando con el <strong>Agente de Desarrollo</strong>, un experto en optimización y edición de código en tiempo real.</p>
    </div>
    </div>
    <!-- Aquí se añadirán dinámicamente los mensajes -->
    </div>

    <!-- Área de entrada de texto y botones -->
    <div class="chat-input-area">
    <div class="input-addons">
    <button type="button" class="action-button file-upload-button" id="file-button" title="Subir archivo">
    <i class="bi bi-paperclip"></i>
    </button>
    <input type="file" id="file-input" class="file-input" multiple>

    <button type="button" class="action-button voice-button" id="voice-button" title="Reconocimiento de voz">
    <i class="bi bi-mic"></i>
    </button>
    </div>

    <div class="chat-input-wrapper">
    <textarea id="chat-input" class="chat-input" placeholder="Escribe tu mensaje aquí... Por ejemplo: 'Crea una página de ventas para productos tecnológicos'" rows="1"></textarea>
    </div>

    <div class="chat-buttons">
    <button type="button" class="action-button send-button" id="send-button">
    <i class="bi bi-send"></i>
    </button>
    </div>
    </div>
    </div>
    </div>
    </div>
    </div>

    <!-- Previsualización (inicialmente oculta) -->
    <div class="col-12 mt-4" id="preview-section" style="display: none;">
    <div class="card card-futuristic">
    <div class="card-header card-header-futuristic d-flex justify-content-between align-items-center">
    <span><i class="bi bi-window me-2"></i>Previsualización</span>
    <div>
    <button id="toggle-preview" class="btn btn-sm btn-futuristic">
    <i class="bi bi-x-lg"></i>
    </button>
    </div>
    </div>
    <div class="card-body p-0">
    <div class="device-toggle-buttons py-2">
    <button class="device-toggle-btn active" data-device="desktop">
    <i class="bi bi-laptop"></i> Escritorio
    </button>
    <button class="device-toggle-btn" data-device="tablet">
    <i class="bi bi-tablet"></i> Tablet
    </button>
    <button class="device-toggle-btn" data-device="mobile">
    <i class="bi bi-phone"></i> Móvil
    </button>
    </div>

    <div class="preview-container" id="preview-container">
    <div class="preview-header">
    <div class="preview-controls">
    <div class="control-btn control-close"></div>
    <div class="control-btn control-minimize"></div>
    <div class="control-btn control-expand"></div>
    </div>
    <div class="preview-url">
    <span>preview.html</span>
    </div>
    </div>
    <iframe id="preview-iframe" class="preview-iframe" title="Previsualización"></iframe>
    </div>
    </div>
    </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// CODESTORM - Sistema de chat con agentes especializados y funcionalidades avanzadas

// Variables globales
let socket;

// Función para obtener la hora actual formateada
function getCurrentTime() {
  const now = new Date();
  return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Función para escapar HTML y prevenir XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Función para formatear Markdown a HTML
function formatMarkdown(text) {
  // Implementación básica de Markdown
  // Código en bloque con resaltado de sintaxis
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, function(match, language, code) {
    language = language || 'plaintext';
    return `<div class="code-block"><pre><code class="language-${language}">${escapeHtml(code.trim())}</code></pre></div>`;
  });

  // Código en línea
  text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');

  // Enlaces
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="chat-link" target="_blank">$1</a>');

  // Negritas
  text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

  // Cursivas
  text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');

  // Listas
  text = text.replace(/^\s*-\s+(.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

  // Párrafos (asegurarse de que el contenido esté en párrafos)
  const paragraphs = text.split('\n\n');
  return paragraphs.map(p => {
    if (p.trim() === '') return '';
    if (p.startsWith('<ul>') || p.startsWith('<div class="code-block">')) return p;
    return `<p>${p.replace(/\n/g, '<br>')}</p>`;
  }).join('');
}

// Función para desplazarse al final del contenedor de mensajes
function scrollToBottom(container) {
  if (!container) return;
  container.scrollTop = container.scrollHeight;
}

// Función para añadir mensaje de sistema
function addSystemMessage(message) {
  const chatMessages = document.getElementById('chat-messages');
  if (!chatMessages) return;

  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message system-message';

  const messageContent = document.createElement('div');
  messageContent.className = 'message-content';
  messageContent.innerHTML = message;

  messageElement.appendChild(messageContent);
  chatMessages.appendChild(messageElement);

  scrollToBottom(chatMessages);
}

// Función para añadir indicador de carga
function addLoadingMessage() {
  const chatMessages = document.getElementById('chat-messages');
  if (!chatMessages) return;

  // Eliminar cualquier indicador de carga existente
  removeLoadingMessage();

  const loadingElement = document.createElement('div');
  loadingElement.className = 'chat-message agent-message loading-message';
  loadingElement.innerHTML = `
    <div class="loading-animation">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  `;

  chatMessages.appendChild(loadingElement);
  scrollToBottom(chatMessages);
}

// Función para eliminar indicador de carga
function removeLoadingMessage() {
  const loadingMessage = document.querySelector('.loading-message');
  if (loadingMessage) {
    loadingMessage.remove();
  }
}

// Función para copiar el contenido de un mensaje al portapapeles
function copyMessageToClipboard(messageElement) {
  if (!messageElement) return;

  // Obtener el contenido del mensaje
  const messageContent = messageElement.querySelector('.message-content');
  if (!messageContent) return;

  // Extraer el texto plano del contenido HTML para copiar
  const textToCopy = messageContent.textContent.trim();

  // Usar la API del portapapeles moderna si está disponible
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(textToCopy)
      .then(() => {
        showCopyFeedback(messageElement);
      })
      .catch(errhtml([\s\S]*?)```/g;
  const htmlMatches = text.match(htmlRegex);

  if (htmlMatches && htmlMatches.length > 0) {
    // Extraer el contenido HTML del primer bloque
    const htmlContent = htmlMatches[0].replace(/```html/, '').replace(/